# Руководство разработчика

## Структура проекта

### Основные скрипты
- `01_extract_book.py` - Извлечение текста из PDF/TXT с умным разбиением на главы
- `02_extract_figures.py` - Извлечение изображений из PDF
- `03_translate_parallel.py` - Параллельный перевод через DeepSeek API
- `04_compile_book.py` - Компиляция переведенной книги в PDF
- `05_create_audiobook.py` - Генерация аудиокниги через edge-tts
- `06_phonetic_replacement.py` - Фонетическая замена для правильного произношения

### Вспомогательные модули
- `deepseek_translator.py` - Класс для работы с DeepSeek API
- `translation_manager.py` - Управление процессом перевода
- `russian_accents.py` - Постановка ударений в русском тексте

### Автоматизация
- `run_all.sh` - Полный цикл обработки книги
- `create_audiobook.sh` - Создание аудиокниги

## Настройка окружения

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
pip install edge-tts pydub  # Для аудиокниг
```

### 2. Настройка API
Создайте файл `.env`:
```bash
# DeepSeek API
USE_LOCAL_MODEL=false
DEEPSEEK_API_KEY=ваш_ключ

# Параметры перевода
MAX_WORKERS=3
TEMPERATURE=0.3
CHUNK_SIZE=800
```

## Рабочий процесс

### Перевод книги
1. Поместите книгу в корень как `book.pdf` или `book.txt`
2. Запустите: `./run_all.sh`
3. Или пошагово:
   ```bash
   python3 01_extract_book.py
   python3 03_translate_parallel.py --all
   python3 04_compile_book.py
   ```

### Создание аудиокниги
```bash
python3 05_create_audiobook.py --voice male --workers 3
```

## Структура данных

### Извлеченные главы
```
extracted_fixed/
├── chapter_000.json  # Структурированный текст главы
└── metadata.json     # Метаданные книги
```

### Переводы
```
translations/
├── chapter_000_translated.json  # Переведенная глава
└── chapter_000_blocks/          # Блоки для параллельного перевода
    ├── block_000.json
    └── ...
```

### Аудиокнига
```
audiobook/
├── temp_audio/              # Временные фрагменты
│   └── chapter_000_group_000.mp3
└── audiobook_complete.mp3   # Финальная аудиокнига
```

## Тестирование

Все тестовые скрипты находятся в `tests/scripts/`:
- `test_accent.py` - Тестирование ударений
- `test_edge_tts_ssml.py` - Проверка SSML поддержки
- `test_parallel_audio.py` - Параллельная генерация аудио
- и другие...

## Оптимизации

### Параллельный перевод
- До 25 потоков одновременно
- Группировка по 3 параграфа с контекстом
- Автоматическое переподключение при ошибках

### Генерация аудио
- Параллельная обработка фрагментов
- Кэширование промежуточных результатов
- Фонетическая замена для правильного произношения

## Управление ударениями

### Методы постановки ударений:
1. **Unicode символ ударения** (рекомендуется):
   ```python
   'процесс' -> 'проце́сс'  # U+0301 после ударной гласной
   ```

2. **Фонетическая транскрипция**:
   ```python
   'CMMI' -> 'си-эм-эм-ай'
   ```

### Ограничения edge-tts
- Python версия НЕ поддерживает полноценный SSML
- Только базовые теги `<voice>` и `<prosody>`
- Используйте символы ударения или фонетическую замену

## Полезные команды

### Очистка проекта
```bash
rm -rf extracted_fixed/ translations/ audiobook/
rm -rf test_extract/ test_translations/
```

### Проверка прогресса
```bash
tail -f audiobook_generation.log
ls -la translations/
```

### Git
```bash
# Добавить изменения (без временных файлов)
git add -A
git status

# Коммит
git commit -m "Улучшения системы перевода и озвучивания"
```

## Известные проблемы

1. **Сплошной текст без разбивки** - экстрактор теперь умеет находить главы в середине текста
2. **Неправильные ударения** - используйте `russian_accents.py`
3. **Долгая генерация аудио** - уменьшите количество воркеров или используйте фоновый режим