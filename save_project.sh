#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞"
echo "=============================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ book.pdf
if [ ! -f "book.pdf" ]; then
    echo "‚ùå –§–∞–π–ª book.pdf –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "   –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∫–Ω–∏–≥–∏ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∞
BOOK_NAME=$(python3 -c "
import fitz
try:
    doc = fitz.open('book.pdf')
    title = doc.metadata.get('title', '').strip()
    if title:
        # –û—á–∏—â–∞–µ–º –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        title = ''.join(c for c in title if c.isalnum() or c in ' -_')[:30]
        print(title)
    else:
        print('book')
    doc.close()
except:
    print('book')
" 2>/dev/null || echo "book")

TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
DEFAULT_NAME="${BOOK_NAME}_${TIMESTAMP}"

echo "üìñ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–Ω–∏–≥–∞: $BOOK_NAME"
echo ""

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞
echo -n "–ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ [$DEFAULT_NAME]: "
read PROJECT_NAME

if [ -z "$PROJECT_NAME" ]; then
    PROJECT_NAME="$DEFAULT_NAME"
fi

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
echo -n "–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): "
read DESCRIPTION

echo ""
echo "üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ '$PROJECT_NAME'..."
echo ""

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–µ–∫—Ç
python3 project_manager.py save "$PROJECT_NAME" "$DESCRIPTION"

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!"
    echo ""
    echo "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:"
    echo "  ‚Ä¢ –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –≥–ª–∞–≤—ã –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã"
    echo "  ‚Ä¢ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã"
    echo "  ‚Ä¢ –ê—É–¥–∏–æ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)"
    echo "  ‚Ä¢ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –∞—É–¥–∏–æ —Ç–µ–∫—Å—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)"
    echo "  ‚Ä¢ –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)"
    echo ""
    echo "–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
    echo "  ./load_project.sh $PROJECT_NAME"
    echo ""
    echo "–ò–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã:"
    echo "  python3 project_manager.py list"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi