#!/bin/bash

# üîä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –¥–ª—è –∞—É–¥–∏–æ–∫–Ω–∏–≥–∏

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env –µ—Å–ª–∏ –µ—Å—Ç—å
if [ -f .env ]; then
    set -a  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    source .env
    set +a
fi

echo "üîä –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π v1.0"
echo "============================================"
echo ""
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:"
echo "1. –ò–∑–≤–ª–µ—á–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤"
echo "2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ DeepSeek"
echo "3. –°–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∞—É–¥–∏–æ–∫–Ω–∏–≥–µ"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
if [ ! -d "translations" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è translations –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "   –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –∫–Ω–∏–≥–∏"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
if [ -z "$DEEPSEEK_API_KEY" ]; then
    echo "‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DEEPSEEK_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    read -p "–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á DeepSeek: " api_key
    if [ -z "$api_key" ]; then
        echo "‚ùå API –∫–ª—é—á –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã"
        exit 1
    fi
    export DEEPSEEK_API_KEY="$api_key"
fi

# –®–∞–≥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤
echo "1Ô∏è‚É£ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤..."
echo ""

python3 07_extract_terms.py --input-dir translations --output extracted_terms.json

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–æ–≤"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
if [ -f "extracted_terms.json" ]; then
    total_terms=$(python3 -c "import json; data=json.load(open('extracted_terms.json')); print(data.get('total_unique_terms', 0))")
    echo ""
    echo "‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤: $total_terms"
fi

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏
echo ""
read -p "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏? (y/n) [y]: " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "‚èπÔ∏è –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 0
fi

# –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ–Ω–µ—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ DeepSeek
echo ""
echo "2Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π —á–µ—Ä–µ–∑ DeepSeek..."
echo "‚ö†Ô∏è –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç API –∑–∞–ø—Ä–æ—Å–æ–≤"
echo ""

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
BATCH_SIZE=20
WORKERS=5

read -p "–†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é $BATCH_SIZE): " user_batch
if [ ! -z "$user_batch" ]; then
    BATCH_SIZE=$user_batch
fi

read -p "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é $WORKERS): " user_workers
if [ ! -z "$user_workers" ]; then
    WORKERS=$user_workers
fi

echo ""
echo "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:"
echo "  ‚Ä¢ –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞: $BATCH_SIZE —Ç–µ—Ä–º–∏–Ω–æ–≤"
echo "  ‚Ä¢ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤: $WORKERS"
echo ""

# –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
python3 08_generate_phonetics.py \
    --terms extracted_terms.json \
    --output phonetics.json \
    --batch-size $BATCH_SIZE \
    --workers $WORKERS

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ–Ω–µ—Ç–∏–∫–∏"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
if [ -f "phonetics.json" ]; then
    echo ""
    echo "‚úÖ –§–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ phonetics.json"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
    echo ""
    echo "üìù –ü—Ä–∏–º–µ—Ä—ã —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π:"
    python3 -c "
import json
data = json.load(open('phonetics.json'))
phonetics = data.get('phonetics', {})
examples = list(phonetics.items())[:5]
for term, trans in examples:
    print(f'  ‚Ä¢ {term} ‚Üí {trans}')
"
fi

# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ!"
echo ""
echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∞—É–¥–∏–æ–∫–Ω–∏–≥–µ:"
echo "   python3 05_create_audiobook.py --phonetics phonetics.json"
echo ""
echo "   –∏–ª–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ:"
echo "   ./create_audiobook.sh"
echo ""
echo "üìå –§–∞–π–ª—ã:"
echo "   ‚Ä¢ extracted_terms.json - –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã"
echo "   ‚Ä¢ phonetics.json - —Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"